"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function convertOldWatchs(e){let t=[];for(const n in e){e[n].reverse();let l={};l.job=n;let a=[],i=0;for(const t of e[n])""!==t&&a.push({id:t,scale:"1",top:"0px",right:44*i+"px"}),i++;l.watch=a,t.push(l)}return t}function insertTTS(e,t){if(!parseInt(e)>0)return;let n=document.createElement("div");n.classList.add("ttsSkill");try{n.innerText=actions[e][`Name_${settings.language}`];let l=document.createElement("input");l.setAttribute("type","text"),l.value=t,l.title=e,n.appendChild(l);let a=document.createElement("button");a.innerHTML="X",a.onclick=function(){this.parentNode.remove()},n.appendChild(a),document.querySelector("#tts").insertBefore(n,document.getElementById("ttsPlus"))}catch{console.log(`导入TTS时：未找到key=${e},value=${t}的action，已跳过此项。`)}}function insertWatch(e,t,n,l){""===e.style.transform&&(e.style.transform="scale(1)"),e.style.width="48px",e.style.height=e.style.width,e.style.lineHeight=e.style.height,e.style.background=`url(./resources/${settings.style.skin}/icon.png),url(${settings.style.url}${t.Url}.png) center / 40px 40px no-repeat `,e.title=t["Name_"+settings.language],e.setAttribute("name",l),e.setAttribute("draggable","true"),e.ondragstart=function(e){pos.x=e.x,pos.y=e.y,pos.right=this.style.right,pos.top=this.style.top;let t=document.createElement("img");e.dataTransfer.setDragImage(t,0,0),e.dataTransfer.effectAllowed="move"},e.ondrag=function(e){let t=this.style.transform.replace(/[^0-9\.]/gi,""),n=document.querySelector("#stepInput").value*t;this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/n)*n,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/n)*n,0),44*(1-t))+"px"},n.ondragover=(e=>e.preventDefault()),e.ondragend=function(e){let t=this.style.transform.replace(/[^0-9\.]/gi,""),n=document.querySelector("#stepInput").value*t;this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/n)*n,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/n)*n,0),44*(1-t))+"px"};let a=document.createElement("aside");a.innerText="X",a.onclick=function(){document.querySelector("#ckboxBeforeDelete").checked&&!confirm(`要删除${a.parentNode.title}吗？`)||this.parentNode.remove()};let i=document.createElement("button");i.innerText="S",i.classList.add("zp"),i.classList.add("zp-left"),i.onclick=function(){e.style.transform="scale(0.5)",e.style.top="0px"};let o=document.createElement("button");o.innerText="M",o.classList.add("zp"),o.classList.add("zp-mid"),o.onclick=function(){e.style.transform="scale(0.75)",e.style.top="0px"};let r=document.createElement("button");r.innerText="L",r.classList.add("zp"),r.classList.add("zp-right"),r.onclick=function(){e.style.transform="scale(1)",e.style.top="0px"},e.appendChild(i),e.appendChild(o),e.appendChild(r),e.appendChild(a),n.appendChild(e)}function toUnifiedScale(e){confirm(language.confirmPer[settings.language]+100*e+"%")&&document.querySelectorAll("#watchs > ul > li> article").forEach(t=>t.style.transform="scale("+e+")")}import{actions}from"../../../resources/data/actions.js";import{jobList}from"../../../resources/data/job.js";import"../../../resources/library/drag-arrange.min.js";import{compareSameGroup}from"../../../resources/function/compareSameGroup.min.js";import{loadItem,saveItem}from"../../../resources/function/localStorage.min.js";import{defaultSettings}from"./defaultSettings.min.js";import{language}from"./language.min.js";let namespace="TeamWatch3",settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),load("settings",{}),{share:{}});settings.style=Object.assign(JSON.parse(JSON.stringify(defaultSettings)).style,load("settings",{}).style);let old=localStorage.getItem("teamWatch");if(old&&!localStorage.getItem("TeamWatch3")){console.log("从旧版本继承了监控技能"),old=JSON.parse(old),settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),{watchs:convertOldWatchs(old.watch)});try{settings.ttsOn=old.TTSOn||settings.ttsOn,settings.tts=old.TTS||settings.tts}catch{}save("settings",settings)}let nav=document.createElement("ul"),skinList={"FFXIV原生":"default","Material-UI(BLACK)":"Material-UI-BLACK","Material-UI(DISCORD)":"Material-UI-DISCORD"},urlList={cafemaker:"https://cafemaker.wakingsands.com/i/",XIVAPI:"https://xivapi.com/i/"};"material"===settings.style.skin&&(settings.style.skin="Material-UI-DISCORD");for(const e in settings){if("ttsOn"===e||void 0===language[e])continue;let t=document.createElement("li");t.title=e,language[e]&&(t.innerText=language[e][settings.language]||e),t.onclick=(()=>{for(const e of document.querySelectorAll("main>article"))e.style.display="none";document.querySelector(`#${t.title}`).style.display="block";for(const e of document.querySelectorAll("nav>ul>li"))e.style.fontWeight="normal";t.style.fontWeight="bold"}),nav.appendChild(t);let n=document.createElement("article");n.id=e,document.querySelector("main").appendChild(n)}document.querySelector("nav").appendChild(nav);let styleOptions=document.createElement("ul");for(const e in settings.style){let t=document.createElement("li");if(void 0!==language[e]){let n;if(t.innerText=language[e][settings.language],isNaN(settings.style[e])){if(n=document.createElement("select"),n.title=e,"skin"===e)for(const e in skinList){let t=document.createElement("option");t.value=skinList[e],t.innerText=e,n.appendChild(t)}else if("url"===e)for(const e in urlList){let t=document.createElement("option");t.value=urlList[e],t.innerText=e,n.appendChild(t)}else if("hideYourself"===e)for(const e of["False","True"]){let t=document.createElement("option");t.value=e,t.innerText=e,n.appendChild(t)}else if("fontColor"===e){for(const e of["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan","DarkGoldenRod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite","Gold","GoldenRod","Gray","Green","GreenYellow","HoneyDew","HotPink","IndianRed ","Indigo ","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"]){let t=document.createElement("option");t.value=e,t.innerText=e,t.style.color=e,n.appendChild(t)}n.onchange=(()=>{n.style.color=n.value}),n.style.color=settings.style.fontColor,n.style.textShadow="-1px 0 3px #000, 0 1px 3px #000, 1px 0 3px #000, 0 -1px 3px #000",n.style.background="#DCDCDC"}n.value=settings.style[e]}else switch(n=document.createElement("input"),n.setAttribute("type","number"),n.onkeypress=(()=>/[\d\.]/.test(String.fromCharCode(event.keyCode))),n.title=e,n.value=settings.style[e],e){case"scale":case"opacity":n.setAttribute("min","0"),n.setAttribute("max","1"),n.setAttribute("step","0.05");break;case"fontSize":n.setAttribute("min","12");break;case"xSpace":n.setAttribute("min","-50"),n.setAttribute("max","50"),n.onkeypress=(()=>!1);break;case"ySpace":n.setAttribute("min","-44"),n.setAttribute("max","44"),n.onkeypress=(()=>!1);break;case"refreshRate":n.setAttribute("step","37")}t.appendChild(n),styleOptions.appendChild(t)}else console.log(`${e}被跳过了`)}document.querySelector("#style").appendChild(styleOptions);let stepInputText=document.createElement("span");stepInputText.innerText=language.stepInputText[settings.language],document.querySelector("#watchs").appendChild(stepInputText);let stepInput=document.createElement("input");stepInput.setAttribute("type","number"),stepInput.setAttribute("step","0.5"),stepInput.value=22,stepInput.id="stepInput",document.querySelector("#watchs").appendChild(stepInput);let unifiedScale=document.createElement("div");unifiedScale.innerText=language.unifiedScale[settings.language];let per50=document.createElement("button");per50.innerText="S",per50.classList.add("unifiedScalePer"),per50.onclick=(()=>toUnifiedScale(.5));let per75=document.createElement("button");per75.innerText="M",per75.classList.add("unifiedScalePer"),per75.value=.75,per75.onclick=(()=>toUnifiedScale(.75));let per100=document.createElement("button");per100.innerText="L",per100.classList.add("unifiedScalePer"),per100.value=1,per100.onclick=(()=>toUnifiedScale(1)),unifiedScale.appendChild(per50),unifiedScale.appendChild(per75),unifiedScale.appendChild(per100),document.querySelector("#watchs").appendChild(unifiedScale);let ckboxText=document.createElement("span");ckboxText.innerText=language.ckboxText[settings.language],document.querySelector("#watchs").appendChild(ckboxText);let ckbox=document.createElement("input");ckbox.setAttribute("type","checkbox"),ckbox.checked=!0,ckbox.id="ckboxBeforeDelete",document.querySelector("#watchs").appendChild(ckbox);let watchOptions=document.createElement("ul"),pos={};[...settings.partySort.Tank,...settings.partySort.Healer,...settings.partySort.Dps,"1","2","3","4","5","6","7","26","29"].forEach(e=>{const t=settings.watchs.find(t=>t.job===e);let n=document.createElement("li");n.innerText=jobList.find(e=>e.ID===t.job)[settings.language],n.style.height="50px",n.style.lineHeight=n.style.height,n.style.outline="gray dashed 1px",n.style.width=40*t.length+"px",n.style.position="relative",n.title=t.job;for(const e of t.watch){let t=actions[e.id];if(void 0===t)console.log(`${e.id}未找到，已跳过`);else{let l=document.createElement("article");l.style.position="absolute",l.style.top=e.top,l.style.right=e.right,l.style.transform=`scale(${e.scale})`,insertWatch(l,t,n,e.id)}}n.style.paddingLeft="0.5em";let l=document.createElement("button");l.innerText="+",l.style.marginLeft="1em",l.style.padding="0.375em 0.75em",l.setAttribute("name",jobList.find(e=>e.ID===t.job).cn),l.onclick=function(){let e=document.querySelector("#watchs > ul > li > div");e&&e.remove();let t=document.createElement("div");t.style.height=n.style.height,t.style.width="300px",t.style.left="8em",t.style.top="0px",t.style.position="absolute";let a=document.createElement("select");for(const e in actions){const t=actions[e];if("0"!==t.ClassJobLevel&&!(parseInt(t.Recast100ms)<50)&&("所有职业"===t.ClassJobCategory||new RegExp(`(^| )${l.getAttribute("name")}($| )`).test(t.ClassJobCategory))&&void 0===compareSameGroup[e]&&void 0===[].slice.call(n.querySelectorAll("article")).find(t=>t.getAttribute("name")===(compareSameGroup[e]||e))){let n=document.createElement("option");n.innerText=t[`Name_${settings.language}`],n.setAttribute("value",e),a.appendChild(n)}}t.appendChild(a);let i=document.createElement("button");i.innerText=language.add[settings.language];let o=document.createElement("button");o.innerText=language.cancel[settings.language],t.appendChild(i),i.onclick=function(){let e=actions[this.parentNode.querySelector("select").value],t=document.createElement("article");t.style.position="absolute",t.style.top="0px";let l=[].slice.call(n.querySelectorAll("article")).reduce((e,t)=>parseInt(e.style.right)>parseInt(t.style.right)?e:t,{style:{right:-44}});t.style.right=parseInt(l.style.right)+44+"px",insertWatch(t,e,n,this.parentNode.querySelector("select").value),o.onclick()},t.appendChild(o),o.onclick=function(){this.parentNode.remove()},n.appendChild(t)},n.appendChild(l),watchOptions.appendChild(n)}),document.querySelector("#watchs").appendChild(watchOptions);let div=document.createElement("div"),ttsOnBtn=document.createElement("input");ttsOnBtn.setAttribute("type","checkbox"),ttsOnBtn.checked="true"===settings.ttsOn,div.appendChild(ttsOnBtn);let ttsOnText=document.createElement("span");ttsOnText.innerText=language.ttsOnText[settings.language],div.appendChild(ttsOnText),document.querySelector("#tts").appendChild(div);for(const e in settings.tts)if(Object.hasOwnProperty.call(settings.tts,e)){const t=settings.tts[e];insertTTS(e,t)}let ttsAdd=document.createElement("button");ttsAdd.id="ttsPlus",ttsAdd.innerText="+",ttsAdd.onclick=function(){if(document.querySelector("#ttsAddSelect"))return;let e=document.createElement("div");e.id="ttsAddSelect";let t=document.createElement("input");t.setAttribute("placeholder",language.searchSkill[settings.language]),t.onchange=function(){n.innerHTML="";for(const e in actions){const t=actions[e];if(-1!==t[`Name_${settings.language}`].indexOf(this.value)){let l=document.createElement("option");l.innerText=t[`Name_${settings.language}`],l.value=e,n.appendChild(l)}}};let n=document.createElement("select");for(const e in actions){if(compareSameGroup[e])continue;let t=document.createElement("option");t.innerText=actions[e][`Name_${settings.language}`],t.value=e,n.appendChild(t)}let l=document.createElement("button");l.innerText=language.add[settings.language],l.onclick=function(){insertTTS(n.value,""),e.remove()};let a=document.createElement("button");a.innerText=language.cancel[settings.language],a.onclick=function(){e.remove()},e.style.position="absolute",e.style.top=1*ttsAdd.offsetTop+40+"px",e.style.left=ttsAdd.offsetLeft+"px",e.appendChild(t),e.appendChild(n),e.appendChild(l),e.appendChild(a),ttsAdd.parentNode.appendChild(e)},document.querySelector("#tts").appendChild(ttsAdd);{let e=document.createElement("div");e.id="jobSort";let t=["Tank>Healer>Dps","Tank>Dps>Healer","Healer>Tank>Dps","Healer>Dps>Tank","Dps>Healer>Tank","Dps>Tank>Healer"],n=["Tank","Healer","Dps"],l=["jobSortTank","jobSortHealer","jobSortDps"];for(const n of l){let l=document.createElement("span");l.innerText=language[n][settings.language],e.appendChild(l);let a=document.createElement("select");for(const e of t){let t=document.createElement("option");t.value=e,t.innerText=e,a.appendChild(t)}a.title=`when${n.replace("jobSort","")}`,a.value=settings.partySort[`when${n.replace("jobSort","")}`],e.appendChild(a)}document.querySelector("#partySort").appendChild(e);for(const e of n){let t=document.createElement("ul");t.classList.add(e);for(const n of settings.partySort[e]){let e=document.createElement("li"),l=document.createElement("p");l.innerText=jobList.find(e=>e.ID===n.toString())[settings.language],l.classList.add("drag"),l.style.height="100%",l.style.width="100%",e.appendChild(l),e.setAttribute("name",n),t.appendChild(e)}document.querySelector("#partySort").appendChild(t)}$("#partySort > ul.Tank > li").arrangeable({dragSelector:".drag"}),$("#partySort > ul.Healer > li").arrangeable({dragSelector:".drag"}),$("#partySort > ul.Dps > li").arrangeable({dragSelector:".drag"})}{let e=document.createElement("select"),t=["cn","en","jp"];for(const n of t){let t=document.createElement("option");t.value=n,t.innerText=n,e.appendChild(t)}e.title="language",e.style.width="5em",e.style.padding="25px",e.style.margin="25px",e.style.fontSize="25px",e.value=settings.language,document.querySelector("#language").appendChild(e)}{let e=document.createElement("p"),t=document.createElement("button"),n=document.createElement("textarea");n.id="shareInInput",t.innerText=language.shareIn[settings.language],e.appendChild(n),e.appendChild(t);let l=document.createElement("p"),a=document.createElement("button"),i=document.createElement("textarea");i.id="shareOutInput",a.innerText=language.shareOut[settings.language],l.appendChild(i),l.appendChild(a),document.querySelector("#share").appendChild(e),document.querySelector("#share").appendChild(l),t.onclick=(()=>{try{let e=JSON.parse(window.decodeURIComponent(window.atob(document.querySelector("#shareInInput").value)));e[1]instanceof Array?save("settings",Object.assign(JSON.parse(JSON.stringify(defaultSettings)),{watchs:convertOldWatchs(e)})):save("settings",e),location.reload()}catch{document.querySelector("#shareInInput").value="格式错误"}}),a.onclick=(()=>{document.querySelector("#shareOutInput").value=window.btoa(window.encodeURIComponent(JSON.stringify(settings)))});let o=document.createElement("button");o.innerText=language.reset,document.querySelector("#share").appendChild(o),o.onclick=(()=>{let e=confirm(language.resetC);e&&(save("settings",defaultSettings),location.reload())})}document.querySelector("#save").innerHTML=language.save[settings.language],document.querySelector("#save").onclick=function(){document.querySelectorAll("#style>ul>li>input").forEach(e=>settings.style[e.title]=e.value),document.querySelectorAll("#style>ul>li>select").forEach(e=>settings.style[e.title]=e.value),document.querySelectorAll("#watchs>ul>li").forEach(e=>{let t=[];e.querySelectorAll("article").forEach(e=>t.push({id:e.getAttribute("name"),scale:e.style.transform.replace(/[^0-9\.]/gi,""),top:e.style.top,right:e.style.right})),settings.watchs.find(t=>t.job===e.title).watch=t}),settings.ttsOn=document.querySelector("#tts > div:nth-child(1) > input[type=checkbox]").checked.toString();let e={};document.querySelectorAll("#tts>div.ttsSkill>input").forEach(t=>e[t.title]=t.value),settings.tts=e,document.querySelectorAll("#partySort>#jobSort>select").forEach(e=>settings.partySort[e.title]=e.value),document.querySelectorAll("#partySort>ul").forEach(e=>{let t=[];e.querySelectorAll("li").forEach(e=>t.push(e.getAttribute("name"))),settings.partySort[e.className]=t}),settings.language=document.querySelector("#language > select").value,save("settings",settings),location.reload(),window.opener&&window.opener.location.reload()},document.querySelector("nav>ul>li:nth-of-type(1)").onclick();