"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function partySort(e){e.sort((e,t)=>parseInt(t.id,16)-parseInt(e.id,16));let t=[],s=e.find(e=>e.id.toString()===charID.toString()&&e.inParty);t.push(s);let n=[];try{for(const e of settings.partySort[`when${jobList.find(e=>e.ID.toString()===s.job.toString()).Role}`].split(">"))n.push(...settings.partySort[e])}catch{return console.log(charID),console.log(e),console.log(s),console.log(settings),console.error("排序时出现未知错误。"),e}return t.push(...e.filter(e=>e.id!==charID&&e.inParty).sort((e,t)=>n.indexOf(baseClass[e.job].toString())-n.indexOf(baseClass[t.job].toString()))),t}function handle(){document.querySelector("main").innerHTML="";for(let e=0;e<party.length;e++){const t=party[e];void 0===t||t.id===charID&&"True"===settings.style.hideYourself||settings.watchs.find(e=>e.job===t.job.toString()).watch.forEach(s=>{let n=actions.find(e=>e.ID===s.id),r=document.createElement("article");r.style.position="absolute",r.style.top=.8*(parseFloat(s.top)+e*(50+parseFloat(settings.style.ySpace)))*settings.style.scale+"px",r.style.right=parseFloat(s.right)*(1+settings.style.xSpace/100)*.8*settings.style.scale+"px",r.style.opacity=settings.style.opacity||1,r.style.width="48px",r.style.height=r.style.width,r.style.lineHeight=r.style.width,r.style.transform=`scale(${.8*s.scale*settings.style.scale})`,setTimeout(()=>{"TRUE"!==n.IsRoleAction&&parseInt(n.ClassJobLevel)>parseInt(levels[t.id])&&(r.style.opacity="0.5")},1e3),r.style.fontSize=settings.style.fontSize+"px",r.style.color=settings.style.fontColor,r.setAttribute("name",e+"-"+n.ID);let i=n.Recast100ms instanceof Function?n.Recast100ms(levels[t.id]?levels[t.id]:0)/10:n.Recast100ms/10;r.setAttribute("reset100ms",i);let o=n.MaxCharges instanceof Function?n.MaxCharges(levels[t.id]?levels[t.id]:0):n.MaxCharges;r.style.background=`\n        url(),\n        url(./resources/${settings.style.skin}/icon.png),\n        url(https://cafemaker.wakingsands.com/i/${n.Url}.png) center / 40px 40px no-repeat `,o>0&&(r.innerText=o,r.style.textShadow="-1px 0 3px rgb(197, 73, 0), 0 1px 3px rgb(197, 73, 0), 1px 0 3px rgb(197, 73, 0), 0 -1px 3px rgb(197, 73, 0)",r.style.fontSize=.8*parseInt(r.style.fontSize)+"px",r.style.padding="15px 0px 0px 30px"),r.use=function(){if("true"===settings.ttsOn&&TTS(settings.tts[n.ID]),r.style.opacity="1","0"===o){clearInterval(r.timer);let e=`url(./resources/${settings.style.skin}/${n.ActionCategory}.png)`,t=r.style.background.split(",");t[0]=`${e} 0px 0px/ 432px 432px`,r.style.background=t.join(",");let s=i;r.timer=setInterval(()=>{let n=1-s/i,o=Math.floor(81*n%9),l=Math.floor(9*n);8!==o||8!==l?(s-=settings.style.refreshRate/1e3,r.innerText=Math.round(s),t[0]=`${e} ${-48*o}px ${-48*l}px / 432px 432px`,r.style.background=t.join(",")):(clearInterval(r.timer),r.innerText="",t[0]="url()",r.style.background=t.join(","))},settings.style.refreshRate)}else{r.innerText=Math.max(parseInt(r.innerText)-1,0);let e=r.style.background.split(",");e[1]=`url(./resources/${settings.style.skin}/${"0"!==r.innerText?"icon":"0charges"}.png)`,r.style.background=e.join(","),r.style.color="0"===r.innerText?"rgb(255,100,100)":"white";let t=i;r.timer||(r.timer=setInterval(()=>{let s=1-t/i,n=Math.floor(81*s%9),l=Math.floor(9*s);8!==n||8!==l?(t-=settings.style.refreshRate/1e3,e[0]=`url(./resources/${settings.style.skin}/charges.png) ${-48*n}px ${-48*l}px / 432px 432px`,e[1]=`url(./resources/${settings.style.skin}/${"0"!==r.innerText?"icon":"0charges"}.png)`,r.style.background=e.join(",")):(clearInterval(r.timer),r.timer=void 0,r.innerText=parseInt(r.innerText)+1,e[0]=`url(./resources/${settings.style.skin}/charges.png) 0px 0px/ 432px 432px`,e[1]=`url(./resources/${settings.style.skin}/${"0"!==r.innerText?"icon":"0charges"}.png)`,r.style.background=e.join(","),r.innerText===o?e[1]=`url(./resources/${settings.style.skin}/icon.png)`:(r.innerText=parseInt(r.innerText)+1,r.use()))},settings.style.refreshRate))}},document.querySelector("main").appendChild(r)})}}import{actions}from"../../../resources/data/actions.js";import{jobList}from"../../../resources/data/job.js";import{compareSame}from"../../../resources/function/compareSameGroup.min.js";import{loadItem,saveItem}from"../../../resources/function/localStorage.min.js";import{TTS}from"../../../resources/function/TTS.js";import{defaultSettings}from"./defaultSettings.min.js";window.onerror=function(){console.log(`遇到了意料之外的错误。\n${JSON.stringify(arguments[0])},\n${JSON.stringify(arguments[1])},\n${JSON.stringify(arguments[2])},\n${JSON.stringify(arguments[3])},\n`)};let settings,namespace="TeamWatch3",baseClass={1:19,2:20,3:21,4:22,5:23,6:24,7:25,26:27,29:30,19:19,21:21,32:32,37:37,24:24,28:28,33:33,20:20,22:22,30:30,34:34,23:23,31:31,38:38,25:25,27:27,35:35,36:36},charID="10000021",party=[],levels={};(function(){function e(e){let t=[];for(const s in e){e[s].reverse();let n={};n.job=s;let r=[],i=0;for(const t of e[s])""!==t&&r.push({id:t,scale:"1",top:"0px",right:44*i+"px"}),i++;n.watch=r,t.push(n)}return t}settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),load("settings",{})),settings.style=Object.assign(JSON.parse(JSON.stringify(defaultSettings)).style,load("settings",{}).style),"material"===settings.style.skin&&(settings.style.skin="Material-UI-DISCORD");let t=localStorage.getItem("teamWatch");if(t&&!localStorage.getItem("TeamWatch3")){console.log("从旧版本中继承了数据"),t=JSON.parse(t),settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),{watchs:e(t.watch)});try{settings.ttsOn=t.TTSOn||settings.ttsOn,settings.tts=t.TTS||settings.tts}catch{}save("settings",settings)}})(),addOverlayListener("ChangePrimaryPlayer",e=>charID=e.charID.toString(16).toUpperCase()),addOverlayListener("onLogEvent",e=>{for(const t of e.detail.logs){let e=t.match(/^.{15}03:(?<id>1.{7}):Added new combatant .+? Job:.+? Level: (?<level>\d+) Max HP/),s=t.match(/^.{15}04:(?<id>1.{7}):/),n=t.match(/^.{15}1[56]:(?<id>1.{7}):[^:]+:(?<ability>[^:]+):.+:0$/);if(e)levels[e.groups.id]=e.groups.level;else if(s)delete levels[s.groups.id];else if(n){let e=party.findIndex(e=>e.id===n.groups.id&&!0===e.inParty);if(e>=0){let t=document.querySelector(`[name="${e}-${compareSame(parseInt(n.groups.ability,16))}"]`);t&&t.use()}}}}),addOverlayListener("PartyChanged",e=>{party=e.party,e.party.length&&(party=partySort(party)),handle()}),startOverlayEvents(),document.addEventListener("onOverlayStateUpdate",e=>e.detail.isLocked?document.querySelector("#readMe").setAttribute("hidden",!0):document.querySelector("#readMe").removeAttribute("hidden")),document.querySelector("#settings").onclick=(()=>{window.open("./settings.html","_blank","width=966,height=720")}),document.querySelector("#showFake").onclick=(()=>{party=[{id:"104600C5",name:"A",worldId:1177,job:19,level:0,inParty:!0},{id:"10440020",name:"B",worldId:1043,job:32,level:0,inParty:!0},{id:"10390069",name:"C",worldId:1177,job:33,level:0,inParty:!0},{id:"1046002D",name:"D",worldId:1178,job:28,level:0,inParty:!0},{id:"102B00B4",name:"E",worldId:1045,job:30,level:0,inParty:!0},{id:"10460007",name:"F",worldId:1178,job:20,level:0,inParty:!0},{id:"103D00BB",name:"G",worldId:1045,job:25,level:0,inParty:!0},{id:"1046000E",name:"H",worldId:1178,job:38,level:0,inParty:!0}],handle()}),document.querySelector("#showUse").onclick=(()=>{let e=settings.ttsOn.toString();settings.ttsOn="false";for(const e of document.querySelectorAll("main>article"))e.use();settings.ttsOn=e.toString()}),document.querySelector("#clear").onclick=(()=>{party=[],handle()});