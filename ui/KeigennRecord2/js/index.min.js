"use strict";function addFooter(){document.querySelector("body > footer > ul").innerHTML=`<li class="select" data-object-id="${youID}" data-select="true" data-job-name="YOU" data-reality-name="YOU">YOU</li>`,party.length&&document.querySelector("body > footer > ul").append(...party.filter(t=>t.id!==youID).map(t=>{let e=document.createElement("li");return e.setAttribute("data-reality-name",t.name),e.setAttribute("data-job-name",(jobList.find(e=>e.ID.toString()===t.job.toString())||{cn:"未知"}).cn),e.appendChild(document.createTextNode(e.getAttribute("data-job-name"))),e.setAttribute("data-object-id",t.id),e.setAttribute("data-select","false"),e})),document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.onclick=function(){document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.setAttribute("data-select","false"),t.classList.remove("select")}),this.setAttribute("data-select","true"),t.classList.add("select"),document.querySelectorAll("body > main > table > tbody > tr:not(:nth-child(1))").forEach(e=>e.style.display=e.getAttribute("data-master-id")===t.getAttribute("data-object-id")?"table-row":"none")},t.oncontextmenu=(()=>document.querySelectorAll("body > footer > ul > li ").forEach(t=>t.innerText=t.innerText===t.getAttribute("data-reality-name")?t.getAttribute("data-job-name"):t.getAttribute("data-reality-name")))})}import{jobList}from"../../../resources/data/job.js";import{status}from"../../../resources/data/status.js";import{getDamage}from"../../../resources/function/damage.js";import{logProcessing}from"../../../resources/function/logProcessing.js";import{keigenn}from"../data/keigenn.js";let party=[],youID="",duration="00:00",FFXIVObject={},scrollMove=!0;class FFObject{constructor(t,e){this.ID=t,this.Name=e,this.Status={}}}addOverlayListener("ChangePrimaryPlayer",t=>{youID=t.charID.toString(16).toUpperCase(),addFooter()}),addOverlayListener("PartyChanged",t=>{party=t.party.filter(t=>t.inParty),addFooter()}),addOverlayListener("CombatData",t=>duration=t.Encounter.duration),addOverlayListener("ChangeZone",()=>FFXIVObject={},document.querySelector("body > main > table > tbody").innerHTML="<tr></tr>"),addOverlayListener("onPartyWipe",()=>{FFXIVObject={},document.querySelector("body > main > table > tbody").insertRow(-1).insertCell(0).innerHTML="团灭",document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight}),addOverlayListener("LogLine",t=>{let e={};switch(t.line[0]){case"21":case"22":if(e=logProcessing(t.line,"action"),"4"!==e.casterID.substring(0,1)||!party.some(t=>t.id===e.targetID&&t.inParty)&&e.targetID!==youID)!party.some(t=>t.id===e.targetID&&t.inParty)&&e.targetID!==youID||void 0===keigenn[e.actionID]||(document.querySelector("body > main > table > tbody").insertRow(-1).insertCell(0).innerHTML=`${duration} ${e.casterName}发动了“${e.actionName}”。`,document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight);else{let a=document.querySelector("body > main > table > tbody").insertRow(-1);a.setAttribute("data-master-id",e.targetID),a.setAttribute("data-master-name",e.targetName),a.style.display="true"===document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")?"table-row":"none";let o=getDamage(t);a.insertCell(0).innerHTML=duration,a.insertCell(1).innerHTML=e.actionName;let n=a.insertCell(2);n.innerHTML=o.value.toLocaleString(),n.setAttribute("data-damage-effect",o.damageEffect),n.title=o.from,n.classList.add(o.damageType);let i=a.insertCell(3);function r(t,r){let a=document.createElement("img");a.setAttribute("src",`https://cafemaker.wakingsands.com/i/${status[parseInt(r,16)].url}`),a.title=FFXIVObject[e[t]].Status[r].name,keigenn[r]&&"0"===keigenn[r][o.damageType]&&a.classList.add("useless"),i.appendChild(a)}if(FFXIVObject[e.targetID])for(const t in FFXIVObject[e.targetID].Status)r("targetID",t);if(FFXIVObject[e.casterID])for(const t in FFXIVObject[e.casterID].Status)r("casterID",t);scrollMove&&"true"===document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")&&(document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight),a.onclick=(()=>{let t=[];t.push(a.children[0].innerHTML),t.push(a.children[2].title),t.push(a.children[1].innerHTML),t.push(a.getAttribute("data-master-name")),t.push(a.children[2].innerHTML);for(const e of a.children[3].children)t.push(e.title);document.querySelector("#toCopy").value=t.join(" "),document.querySelector("#toCopy").select(),document.execCommand("copy"),document.querySelector("#hint").innerText="已复制！",document.querySelector("#hint").classList.add("anim-opacity2"),setTimeout(()=>document.querySelector("#hint").classList.remove("anim-opacity2"),2e3)})}break;case"26":e=logProcessing(t.line,"status"),void 0===keigenn[e.statusID]||!party.some(t=>t.id===e.targetID&&t.inParty)&&e.targetID!==youID&&"4"!==e.targetID.substring(0,1)||(FFXIVObject[e.targetID]=FFXIVObject[e.targetID]||new FFObject(e.targetID,e.targetName),FFXIVObject[e.targetID].Status[e.statusID]={name:e.statusName,caster:e.casterName});break;case"30":if(e=logProcessing(t.line,"status"),void 0!==keigenn[e.statusID]&&(party.some(t=>t.id===e.targetID&&t.inParty)||e.targetID===youID||"4"===e.targetID.substring(0,1)))try{delete FFXIVObject[e.targetID].Status[e.statusID]}catch{}}}),startOverlayEvents(),document.querySelector("main").onscroll=(t=>scrollMove=document.querySelector("main").scrollHeight-282-t.target.scrollTop<5);