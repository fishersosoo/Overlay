"use strict";function getUrlParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}function addFooter(){document.querySelector("body > footer > ul").innerHTML='<li class="select" data-select="true" data-job-name="All" data-reality-name="All" id="all">ALL</li>',party.length&&document.querySelector("body > footer > ul").append(...party.map(t=>{let e=document.createElement("li");return e.setAttribute("data-reality-name",t.id===youID?"YOU":t.name),e.setAttribute("data-job-name",t.id===youID?"YOU":(jobList.find(e=>e.ID.toString()===t.job.toString())||{cn:"?"}).simple1),e.appendChild(document.createTextNode(e.getAttribute("data-job-name"))),e.setAttribute("data-object-id",t.id),e.setAttribute("data-select","false"),e})),document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.onclick=function(){document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.setAttribute("data-select","false"),t.classList.remove("select")}),this.setAttribute("data-select","true"),t.classList.add("select"),document.querySelectorAll("body > main > table > tbody > tr").forEach(e=>{"all"===t.getAttribute("id")||e.getAttribute("data-master-id")===t.getAttribute("data-object-id")?e.style.display="table-row":e.style.display="none"})},t.oncontextmenu=(()=>document.querySelectorAll("body > footer > ul > li ").forEach(t=>t.innerText=t.innerText===t.getAttribute("data-reality-name")?t.getAttribute("data-job-name"):t.getAttribute("data-reality-name")))})}function startCombat(){inCombat=!0,clearTimeout(combatTimer);let t=0;combatTimer=setInterval(()=>{duration=`${parseInt(++t/60).toString().padStart(2,"0")}:${parseInt(t%60).toString().padStart(2,"0")}`},1e3)}import{jobList}from"../../../resources/data/job.js";import{status}from"../../../resources/data/status.js";import{getDamage}from"../../../resources/function/damage.js";import{logProcessing}from"../../../resources/function/logProcessing.js";import{keigenn}from"../data/keigenn.js";let party=[],youID="",duration="00:00",FFXIVObject={},scrollMove=!0,inCombat=!1,combatTimer=0;class FFObject{constructor(t,e){this.ID=t,this.Name=e,this.Status={}}}document.querySelector("main").style.backgroundColor=`rgba(5,5,5,${getUrlParam("bgOpacity")||.45})`,document.body.style.opacity=getUrlParam("bodyOpacity")||1,addOverlayListener("ChangePrimaryPlayer",t=>{youID=t.charID.toString(16).toUpperCase(),addFooter()}),addOverlayListener("PartyChanged",t=>{party=t.party.filter(t=>t.inParty),addFooter()});try{addOverlayListener("onInCombatChangedEvent",t=>t.detail.inACTCombat&&!inCombat?startCombat():"")}catch{addOverlayListener("CombatData",t=>duration=t.Encounter.duration)}addOverlayListener("ChangeZone",()=>{FFXIVObject={},document.querySelector("body > main > table > tbody").innerHTML="",inCombat=!1,clearTimeout(combatTimer),duration="00:00"}),addOverlayListener("onPartyWipe",()=>{FFXIVObject={},document.querySelector("body > main > table > tbody").insertRow(-1).insertCell(0).innerHTML="团灭",document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight,inCombat=!1,clearTimeout(combatTimer),duration="00:00"}),addOverlayListener("LogLine",t=>{let e;switch(t.line[0]){case"21":case"22":e=logProcessing(t.line,"action");let r=getDamage(t);if("damage"===r.type&&"4"===e.casterID.substring(0,1)&&(e.targetID===youID||party.some(t=>t.id===e.targetID&&t.inParty))){inCombat||"00:00"!==duration||startCombat();let t=document.querySelector("body > main > table > tbody").insertRow(-1);t.setAttribute("data-master-id",e.targetID),t.setAttribute("data-master-name",e.targetName),"true"===document.querySelector("#all").getAttribute("data-select")||"true"===document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")?t.style.display="table-row":t.style.display="none",t.insertCell(0).innerHTML=duration,t.insertCell(1).innerHTML=-1===e.actionName.indexOf("Unknown_")?e.actionName:"(平A?)";let o=t.insertCell(2);try{let t=jobList.find(t=>t.ID===(party.find(t=>t.id===e.targetID)||{job:"unknown"}).job.toString());o.innerHTML=e.targetID===youID?"YOU":t.simple2,o.classList.add(party.length?t.en:"YOU")}catch{o.innerHTML=e.targetName}let n=t.insertCell(3);n.innerHTML=r.value.toLocaleString(),n.setAttribute("data-damage-effect",r.damageEffect),n.title=r.from,n.classList.add(r.damageType);let i=t.insertCell(4);function a(t,a){let o=document.createElement("img");o.setAttribute("src",`https://cafemaker.wakingsands.com/i/${status[parseInt(a,16)].url}`),o.title=FFXIVObject[e[t]].Status[a].name,keigenn[a]&&"0"===keigenn[a][r.damageType]&&o.classList.add("useless"),i.appendChild(o)}if(FFXIVObject[e.targetID])for(const t in FFXIVObject[e.targetID].Status)a("targetID",t);if(FFXIVObject[e.casterID])for(const t in FFXIVObject[e.casterID].Status)a("casterID",t);!scrollMove||"true"!==document.querySelector("#all").getAttribute("data-select")&&"true"!==document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")||(document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight),t.onclick=(()=>{let e=[];e.push(t.children[0].innerHTML),e.push(t.children[3].title),e.push(t.children[1].innerHTML),e.push(t.getAttribute("data-master-name")),e.push(t.children[3].innerHTML);for(const a of t.children[4].children)e.push(a.title);document.querySelector("#toCopy").value=e.join(" "),document.querySelector("#toCopy").select(),document.execCommand("copy"),document.querySelector("#hint").innerText="已复制！",document.querySelector("#hint").classList.add("anim-opacity2"),setTimeout(()=>document.querySelector("#hint").classList.remove("anim-opacity2"),1e3)})}break;case"26":e=logProcessing(t.line,"status"),void 0===keigenn[e.statusID]||!party.some(t=>t.id===e.targetID&&t.inParty)&&e.targetID!==youID&&"4"!==e.targetID.substring(0,1)||(FFXIVObject[e.targetID]=FFXIVObject[e.targetID]||new FFObject(e.targetID,e.targetName),FFXIVObject[e.targetID].Status[e.statusID]={name:e.statusName,caster:e.casterName});break;case"30":if(e=logProcessing(t.line,"status"),void 0!==keigenn[e.statusID]&&(party.some(t=>t.id===e.targetID&&t.inParty)||e.targetID===youID||"4"===e.targetID.substring(0,1)))try{delete FFXIVObject[e.targetID].Status[e.statusID]}catch{}}}),startOverlayEvents(),document.querySelector("main").onscroll=(t=>{scrollMove=document.querySelector("main").scrollHeight-document.body.offsetHeight-t.target.scrollTop<20}),document.querySelector("header").onclick=function(){let t=document.querySelector("main");"0"===t.style.opacity?(t.style.opacity="1",this.style.opacity="0.5"):(t.style.opacity="0",this.style.opacity="1")};