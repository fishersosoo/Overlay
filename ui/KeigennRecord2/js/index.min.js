"use strict";function getUrlParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}function addFooter(){document.querySelector("body > footer > ul").innerHTML='<li class="select" data-select="true" data-job-name="All" data-reality-name="All" id="all">ALL</li>',party.length&&document.querySelector("body > footer > ul").append(...party.map(t=>{let e=document.createElement("li");return e.setAttribute("data-reality-name",t.id===youID?"YOU":t.name),e.setAttribute("data-job-name",t.id===youID?"YOU":(jobList.find(e=>e.ID.toString()===t.job.toString())||{cn:"?"}).simple1),e.appendChild(document.createTextNode(e.getAttribute("data-job-name"))),e.setAttribute("data-object-id",t.id),e.setAttribute("data-select","false"),e})),document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.onclick=function(){document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.setAttribute("data-select","false"),t.classList.remove("select")}),this.setAttribute("data-select","true"),t.classList.add("select"),document.querySelectorAll("body > main > table > tbody > tr").forEach(e=>{"all"===t.getAttribute("id")||e.getAttribute("data-master-id")===t.getAttribute("data-object-id")?e.style.display="table-row":e.style.display="none"})},t.oncontextmenu=(()=>document.querySelectorAll("body > footer > ul > li ").forEach(t=>t.innerText=t.innerText===t.getAttribute("data-reality-name")?t.getAttribute("data-job-name"):t.getAttribute("data-reality-name")))})}function speTr(t,e=null,a=5){let r=tbody.insertRow(-1).insertCell(0);return r.innerText=t,e&&r.classList.add(e),r.classList.add("spe"),r.colSpan=a,document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight,r.parentNode}function startCombat(){inCombat=!0,clearTimeout(combatTimer);let t=0;combatTimer=setInterval(()=>{duration=`${parseInt(++t/60).toString().padStart(2,"0")}:${parseInt(t%60).toString().padStart(2,"0")}`},1e3)}function prefixZero(t,e){return(Array(e).join(0)+t).slice(-e)}import{jobList}from"../../../resources/data/job.js";import{status}from"../../../resources/data/status.js";import{getDamage}from"../../../resources/function/damage.js";import{logProcessing}from"../../../resources/function/logProcessing.js";import{keigenn}from"../data/keigenn.js";let party=[],youID="",duration="00:00",FFXIVObject={},scrollMove=!0,inCombat=!1,combatTimer=0,maxLength=parseInt(getUrlParam("maxLength")||999);class FFObject{constructor(t,e){this.ID=t,this.Name=e,this.Status={}}}document.querySelector("main").style.backgroundColor=`rgba(5,5,5,${getUrlParam("bgOpacity")||.45})`,document.body.style.opacity=getUrlParam("bodyOpacity")||1,addOverlayListener("ChangePrimaryPlayer",t=>{youID=t.charID.toString(16).toUpperCase(),addFooter()}),addOverlayListener("PartyChanged",t=>{party=t.party.filter(t=>t.inParty||"true"===getUrlParam("24Mode")),addFooter()});try{addOverlayListener("onInCombatChangedEvent",t=>t.detail.inACTCombat&&!inCombat?startCombat():"")}catch{addOverlayListener("CombatData",t=>duration=t.Encounter.duration)}addOverlayListener("ChangeZone",t=>{FFXIVObject={},null!==tbody.lastChild&&"changeZone"===tbody.lastChild.firstChild.classList[0]&&tbody.lastChild.remove(),speTr(t.zoneName,"changeZone"),inCombat=!1,clearTimeout(combatTimer),duration="00:00"}),addOverlayListener("onPartyWipe",()=>{FFXIVObject={},speTr("团灭","ace"),inCombat=!1,clearTimeout(combatTimer),duration="00:00"});const tbody=document.querySelector("body > main > table > tbody");addOverlayListener("LogLine",t=>{let e;switch(t.line[0]){case"21":case"22":e=logProcessing(t.line,"action");let o=getDamage(t);if("damage"===o.type&&"4"===e.casterID.substring(0,1)&&(e.targetID===youID||party.some(t=>t.id===e.targetID&&(t.inParty||"true"===getUrlParam("24Mode"))))){inCombat||"00:00"!==duration||startCombat(),maxLength>0&&tbody.childElementCount>=maxLength&&tbody.deleteRow(0);let t=tbody.insertRow(-1);t.setAttribute("data-master-id",e.targetID),t.setAttribute("data-master-name",e.targetName),"true"===document.querySelector("#all").getAttribute("data-select")||"true"===document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")?t.style.display="table-row":t.style.display="none",t.insertCell(0).innerHTML=duration,t.insertCell(1).innerHTML=-1===e.actionName.indexOf("Unknown_")?e.actionName:"平A？";let n=t.insertCell(2);try{let t=jobList.find(t=>t.ID===(party.find(t=>t.id===e.targetID)||{job:"unknown"}).job.toString());n.innerHTML=e.targetID===youID?"YOU":t.simple2,n.classList.add(e.targetID!==youID&&party.length?t.en:"YOU")}catch{n.innerHTML=e.targetName}let i=t.insertCell(3);i.innerHTML=o.value.toLocaleString(),i.setAttribute("data-damage-effect",o.damageEffect),i.title=o.from,i.classList.add(o.damageType);let l=t.insertCell(4);function a(t,a,r=0){function n(t){if(0!==r){let e=t.split("/");return`${e[0]}/${prefixZero(parseInt(e[1])+parseInt(r-1),e[1].length)}`}return t}let i=document.createElement("img");i.setAttribute("src",`https://cafemaker.wakingsands.com/i/${n(status[parseInt(a,16)].url)}.png`),i.title=FFXIVObject[e[t]].Status[a].name,keigenn[a]&&0===keigenn[a][o.damageType]&&i.classList.add("useless"),l.appendChild(i)}function r(t){for(const r in FFXIVObject[e[t]].Status)a(t,r,parseInt(FFXIVObject[e[t]].Status[r].stack))}FFXIVObject[e.targetID]&&r("targetID"),FFXIVObject[e.casterID]&&r("casterID"),!scrollMove||"true"!==document.querySelector("#all").getAttribute("data-select")&&"true"!==document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")||(document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight),t.onclick=(()=>{let e=[];e.push(t.children[0].innerHTML),e.push(t.children[3].title),e.push(t.children[1].innerHTML),e.push(t.getAttribute("data-master-name")),e.push(t.children[3].innerHTML);for(const a of t.children[4].children)e.push(a.title);document.querySelector("#toCopy").value=e.join(" "),document.querySelector("#toCopy").select(),document.execCommand("copy"),document.querySelector("#hint").innerText="已复制！",document.querySelector("#hint").classList.add("anim-opacity2"),setTimeout(()=>document.querySelector("#hint").classList.remove("anim-opacity2"),1e3)})}break;case"26":case"30":if(e=logProcessing(t.line,"status"),void 0!==keigenn[e.statusID]&&("player"===keigenn[e.statusID].condition&&(party.some(t=>t.id===e.targetID)||e.targetID===youID)||"enemy"===keigenn[e.statusID].condition&&"4"===e.targetID.substring(0,1)))if("26"===t.line[0])FFXIVObject[e.targetID]=FFXIVObject[e.targetID]||new FFObject(e.targetID,e.targetName),FFXIVObject[e.targetID].Status[e.statusID]={name:e.statusName,caster:e.casterName,stack:t.line[9]};else try{delete FFXIVObject[e.targetID].Status[e.statusID]}catch{}break;case"25":if(t.line[2]===youID||party.some(e=>e.id===t.line[2]&&(e.inParty||"true"===getUrlParam("24Mode")))){let e;try{let a=jobList.find(e=>e.ID===(party.find(e=>e.id===t.line[2])||{job:"unknown"}).job.toString());e=t.line[2]===youID?"你":a.simple2}catch{e=t.line[3]}let a=speTr(`💀${e}被${t.line[5]}做掉了！`,"deathEvent",4);a.setAttribute("data-master-id",t.line[2]),a.setAttribute("data-master-name",t.line[3]),"true"===document.querySelector("#all").getAttribute("data-select")||"true"===document.querySelector(`body > footer > ul > li[data-object-id="${t.line[2]}"]`).getAttribute("data-select")?a.style.display="table-row":a.style.display="none",a.insertCell(0).innerHTML=duration}}}),startOverlayEvents(),document.querySelector("main").onscroll=(t=>{scrollMove=document.querySelector("main").scrollHeight-document.body.offsetHeight-t.target.scrollTop<20}),document.querySelector("header").onclick=function(){let t=document.querySelector("main"),e=document.querySelector("footer");"0"===t.style.opacity?(t.style.opacity="1",e.style.opacity="1",this.classList.remove("hide")):(t.style.opacity="0",e.style.opacity="0",this.classList.add("hide"))};