"use strict";function getUrlParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}function addFooter(){document.querySelector("body > footer > ul").innerHTML='<li class="select" data-select="true" data-job-name="All" data-reality-name="All" id="all">ALL</li>',party.length&&document.querySelector("body > footer > ul").append(...party.map(t=>{let e=document.createElement("li");return e.setAttribute("data-reality-name",t.id===youID?"YOU":t.name),e.setAttribute("data-job-name",t.id===youID?"YOU":(jobList.find(e=>e.ID.toString()===t.job.toString())||{cn:"?"}).simple1),e.appendChild(document.createTextNode(e.getAttribute("data-job-name"))),e.setAttribute("data-object-id",t.id),e.setAttribute("data-select","false"),e})),document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.onclick=function(){document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.setAttribute("data-select","false"),t.classList.remove("select")}),this.setAttribute("data-select","true"),t.classList.add("select"),document.querySelectorAll("body > main > table > tbody > tr").forEach(e=>{"all"===t.getAttribute("id")||e.getAttribute("data-master-id")===t.getAttribute("data-object-id")?e.style.display="table-row":e.style.display="none"})},t.oncontextmenu=(()=>document.querySelectorAll("body > footer > ul > li ").forEach(t=>t.innerText=t.innerText===t.getAttribute("data-reality-name")?t.getAttribute("data-job-name"):t.getAttribute("data-reality-name")))})}function speTr(t){let e=document.querySelector("body > main > table > tbody").insertRow(-1).insertCell(0);if(e.innerText=t,"团灭"!==t){let t=document.createElement("span");t.innerText=swtichText[0],t.onclick=function(){let e=this.parentNode.parentNode,a=0;for(;null!==(e=e.previousSibling);)a++;let r=this.parentNode.parentNode,o=0;for(;r=r.nextSibling,null!==r&&"spe"!==r.children[0].classList[0]||"团灭"===r.innerText;)o++;let n=document.querySelector("body > main > table > tbody");for(let e=a+1;e<a+1+o&&e<n.children.length;e++){const a=n.children[e];a.style.display=t.innerText===swtichText[0]?"none":"table-row"}t.innerText=t.innerText===swtichText[0]?swtichText[1]:swtichText[0]},e.appendChild(t)}else e.classList.add("ace");e.classList.add("spe"),e.colSpan="5",document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight}function startCombat(){inCombat=!0,clearTimeout(combatTimer);let t=0;combatTimer=setInterval(()=>{duration=`${parseInt(++t/60).toString().padStart(2,"0")}:${parseInt(t%60).toString().padStart(2,"0")}`},1e3)}import{jobList}from"../../../resources/data/job.js";import{status}from"../../../resources/data/status.js";import{getDamage}from"../../../resources/function/damage.js";import{logProcessing}from"../../../resources/function/logProcessing.js";import{keigenn}from"../data/keigenn.js";let party=[],youID="",duration="00:00",FFXIVObject={},scrollMove=!0,inCombat=!1,combatTimer=0,maxLength=parseInt(getUrlParam("maxLength")||999);class FFObject{constructor(t,e){this.ID=t,this.Name=e,this.Status={}}}document.querySelector("main").style.backgroundColor=`rgba(5,5,5,${getUrlParam("bgOpacity")||.45})`,document.body.style.opacity=getUrlParam("bodyOpacity")||1,addOverlayListener("ChangePrimaryPlayer",t=>{youID=t.charID.toString(16).toUpperCase(),addFooter()}),addOverlayListener("PartyChanged",t=>{party=t.party.filter(t=>t.inParty||"true"===getUrlParam("24Mode")),addFooter()});try{addOverlayListener("onInCombatChangedEvent",t=>t.detail.inACTCombat&&!inCombat?startCombat():"")}catch{addOverlayListener("CombatData",t=>duration=t.Encounter.duration)}let swtichText=["收起","展开"];addOverlayListener("ChangeZone",t=>{FFXIVObject={},speTr(t.zoneName),inCombat=!1,clearTimeout(combatTimer),duration="00:00"}),addOverlayListener("onPartyWipe",()=>{FFXIVObject={},speTr("团灭"),inCombat=!1,clearTimeout(combatTimer),duration="00:00"}),addOverlayListener("LogLine",t=>{let e;switch(t.line[0]){case"21":case"22":e=logProcessing(t.line,"action");let r=getDamage(t);if("damage"===r.type&&(e.targetID===youID||party.some(t=>t.id===e.targetID&&(t.inParty||"true"===getUrlParam("24Mode"))))){inCombat||"00:00"!==duration||startCombat();let t=document.querySelector("body > main > table > tbody");maxLength>0&&t.childElementCount>=maxLength&&t.deleteRow(0);let o=t.children,n=o.length;for(let t=o.length-1;t>=0;t--){const e=o[t];if(n--,"spe"===e.children[0].classList[0]&&"none"!==e.style.display)break}let i=t.insertRow(-1);i.setAttribute("data-master-id",e.targetID),i.setAttribute("data-master-name",e.targetName),null===t.children[n].firstChild||t.children[n].firstChild.lastChild.innerText===swtichText[1]||"true"!==document.querySelector("#all").getAttribute("data-select")&&"true"!==document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")?i.style.display="none":i.style.display="table-row",i.insertCell(0).innerHTML=duration,i.insertCell(1).innerHTML=-1===e.actionName.indexOf("Unknown_")?e.actionName:"（平A？）";let l=i.insertCell(2);try{let t=jobList.find(t=>t.ID===(party.find(t=>t.id===e.targetID)||{job:"unknown"}).job.toString());l.innerHTML=e.targetID===youID?"YOU":t.simple2,l.classList.add(e.targetID!==youID&&party.length?t.en:"YOU")}catch{l.innerHTML=e.targetName}let s=i.insertCell(3);s.innerHTML=r.value.toLocaleString(),s.setAttribute("data-damage-effect",r.damageEffect),s.title=r.from,s.classList.add(r.damageType);let c=i.insertCell(4);function a(t,a){let o=document.createElement("img");o.setAttribute("src",`https://cafemaker.wakingsands.com/i/${status[parseInt(a,16)].url}`),o.title=FFXIVObject[e[t]].Status[a].name,keigenn[a]&&"0"===keigenn[a][r.damageType]&&o.classList.add("useless"),c.appendChild(o)}if(FFXIVObject[e.targetID])for(const t in FFXIVObject[e.targetID].Status)a("targetID",t);if(FFXIVObject[e.casterID])for(const t in FFXIVObject[e.casterID].Status)a("casterID",t);!scrollMove||"true"!==document.querySelector("#all").getAttribute("data-select")&&"true"!==document.querySelector(`body > footer > ul > li[data-object-id="${e.targetID}"]`).getAttribute("data-select")||(document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight),i.onclick=(()=>{let t=[];t.push(i.children[0].innerHTML),t.push(i.children[3].title),t.push(i.children[1].innerHTML),t.push(i.getAttribute("data-master-name")),t.push(i.children[3].innerHTML);for(const e of i.children[4].children)t.push(e.title);document.querySelector("#toCopy").value=t.join(" "),document.querySelector("#toCopy").select(),document.execCommand("copy"),document.querySelector("#hint").innerText="已复制！",document.querySelector("#hint").classList.add("anim-opacity2"),setTimeout(()=>document.querySelector("#hint").classList.remove("anim-opacity2"),1e3)})}break;case"26":e=logProcessing(t.line,"status"),void 0===keigenn[e.statusID]||!party.some(t=>t.id===e.targetID)&&e.targetID!==youID&&"4"!==e.targetID.substring(0,1)||(FFXIVObject[e.targetID]=FFXIVObject[e.targetID]||new FFObject(e.targetID,e.targetName),FFXIVObject[e.targetID].Status[e.statusID]={name:e.statusName,caster:e.casterName});break;case"30":if(e=logProcessing(t.line,"status"),void 0!==keigenn[e.statusID]&&(party.some(t=>t.id===e.targetID)||e.targetID===youID||"4"===e.targetID.substring(0,1)))try{delete FFXIVObject[e.targetID].Status[e.statusID]}catch{}}}),startOverlayEvents(),document.querySelector("main").onscroll=(t=>{scrollMove=document.querySelector("main").scrollHeight-document.body.offsetHeight-t.target.scrollTop<20}),document.querySelector("header").onclick=function(){let t=document.querySelector("main"),e=document.querySelector("footer");"0"===t.style.opacity?(t.style.opacity="1",e.style.opacity="1",this.classList.remove("hide")):(t.style.opacity="0",e.style.opacity="0",this.classList.add("hide"))};