"use strict";function getUrlParam(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?unescape(a[2]):null}import{actions}from"../../../resources/data/actions.min.js";import{logProcessing}from"../../../resources/function/logProcessing.min.js";import{items}from"../../../resources/data/item.min.js";let party,player,timer,lastStartCasting,lock={ID:null,Name:null};document.body.style.backgroundColor=`rgba(5,5,5,${getUrlParam("bgOpacity")||.25})`,document.addEventListener("onOverlayStateUpdate",e=>{e.detail.isLocked?(document.querySelector("#readMe").setAttribute("hidden",!0),document.body.style.display="none"):document.querySelector("#readMe").removeAttribute("hidden")}),addOverlayListener("ChangeZone",()=>isLock=!1),addOverlayListener("PartyChanged",e=>party=e.party||party),addOverlayListener("ChangePrimaryPlayer",e=>player=e.charID.toString(16).toUpperCase()),addOverlayListener("LogLine",e=>{if("20"===e.line[0]||"21"===e.line[0]||"22"===e.line[0]&&"0"===e.line[45]){let t=logProcessing(e.line,"action");if(t.casterID===lock.ID||null===lock.ID&&t.casterID===player){let a=document.createElement("section"),r=actions[parseInt(t.actionID,16).toString()];if(r=r||{Url:"000000/000405",ActionCategory:"能力"},"自动攻击"===r.ActionCategory)a.classList.add("AA");else{let n=document.createElement("img");n.setAttribute("src",`https://cafemaker.wakingsands.com/i/${((0===t.actionName.indexOf("Item_")?items[parseInt(e.line[5].substr(5,5),16)-("F"===e.line[5].substr(5,1)?1e6:0)]:r)||{Url:"000000/000405"}).Url}.png`),n.onerror=function(){this.src=this.src.replace("https://cafemaker.wakingsands.com/","https://xivapi.com/")},n.setAttribute("alt",t.actionName),"20"===e.line[0]?(a.classList.add("casting"),lastStartCasting=a):(lastStartCasting&&lastStartCasting.remove(),a.classList.add("能力"===(r||{ActionCategory:"能力"}).ActionCategory?"oGCD":"GCD")),a.append(n)}let n=document.createElement("img");n.setAttribute("src","../../../resources/img/icon.png"),n.classList.add("icon"),a.append(n),document.querySelector("main").appendChild(a),document.body.style.display="block",clearTimeout(timer),"0"===getUrlParam("autoHideTime")||isLock||(timer=setTimeout(()=>{document.body.style.display="none"},Math.max(parseInt(getUrlParam("autoHideTime")),1e4)||6e4)),setTimeout(()=>{a.remove()},25e3)}else t.casterID===player&&(document.body.style.display="block")}});let aside=document.querySelector("header>aside"),span=document.querySelector("header>span"),isLock=!1;document.querySelector("header").onclick=(()=>{isLock=!isLock,lock={ID:span.getAttribute("data-id"),Name:span.getAttribute("data-name")}}),addOverlayListener("EnmityTargetData",e=>{if(null===e.Target)aside.innerText="",isLock?span.innerText=lock.Name:(span.innerText="",lock={ID:null,Name:null});else{let t=e.Target.ID.toString(16).toUpperCase();isLock?(aside.innerText="",span.innerText=lock.Name):isLock||"1"!==t.substr(0,1)||t===player?(aside.innerText="",isLock?span.innerText=lock.Name:(span.innerText="",lock={ID:null,Name:null})):(aside.innerText="点击这里切换为:",span.innerText=e.Target.Name,span.setAttribute("data-name",e.Target.Name),span.setAttribute("data-id",t))}}),startOverlayEvents();