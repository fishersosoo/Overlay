import{S as b}from"./sweetalert2.6e640675.js";import"./hasOverlayPluginApi.ecf97ca4.js";import{u as k,T as L}from"./timeline.6a945905.js";import{_ as M}from"./index.f112d070.js";import{d as z,m as P,r as _,o as f,c as g,u as r,F as $,n as J,t as B,q as Z,f as q}from"./vendor.e055c356.js";import"https://overlay.diemoe.net/common/common.min.js";const H={id:"wrapper"},R={key:0,class:"optionalTimelines"},U=["onClick"],G=z({setup(K){const i=k(),o=P({loadedTimeline:[],optionalTimeline:[]});let T=_(0),l=_(0-i.configValues.preBattle),p=_(0),h,c=!0,j=300,w,s={zoneId:"0",job:"NONE"},m,v=!1;A();function A(){var e;addOverlayListener("onLogEvent",E),addOverlayListener("onPlayerChangedEvent",x),addOverlayListener("ChangeZone",F),addOverlayListener("BroadcastMessage",O),addOverlayListener("onInCombatChangedEvent",V),startOverlayEvents(),i.loadTimelineSettings(),s.job=(e=localStorage.getItem("timelineLastJob"))!=null?e:"NONE"}function y(e){C(),o.loadedTimeline.length=0,o.optionalTimeline.length=0;let t=i.getTimeline(e);t.length===1?d(t[0]):t.length>1&&(o.optionalTimeline=t)}function D(e){d(e)}function d(e){e&&(e==null?void 0:e.timeline)&&(o.loadedTimeline=i.parseTimeline(e.timeline),o.loadedTimeline.sort((t,n)=>t.time-n.time),b.fire({position:"top-end",icon:"success",text:`\u52A0\u8F7D\u4E86${e.name}~`,showConfirmButton:!1,timer:1e3,backdrop:!1}),m=e)}function C(){clearInterval(Number(h)),T.value=0,l.value=0-i.configValues.preBattle,p.value=0}function S(e){T.value=new Date().getTime()+e*1e3,clearInterval(Number(h)),h=setInterval(()=>{l.value=(new Date().getTime()-T.value+p.value)/1e3;let t;o.loadedTimeline.filter(n=>n.tts&&!n.alertAlready&&n.time-i.configValues.ttsAdvance<=l.value).forEach(n=>{n.alertAlready=!0,n.tts&&c&&(t=n.tts,c=!1),t&&N(t)})},i.configValues.refreshRateMs)}function E(e){for(const t of e.detail.logs){let n=t.match(/^.{14} (\w+ |)00:(?:00b9|0139)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(]+[（(]/i);if(n)S(parseInt(n.groups.cd));else if(s.zoneId==="1009"&&/^.{14} (?:Director |)21:.{8}:8.{5}1A/.test(t))y(s);else if(/^.{14} (?:Director |)21:.{8}:40000010/.test(t))C(),d(m);else{const u=o.loadedTimeline.find(a=>a.sync&&a.windowBefore&&a.windowAfter&&a.sync.test(t)&&l.value>=a.time-a.windowBefore&&l.value<=a.time+Number(a.windowAfter));u&&I(u.jump||u.time)}}}function I(e){p.value+=(e-l.value)*1e3}function x(e){s.job!==e.detail.job&&(localStorage.setItem("timelineLastJob",e.detail.job),s.job=e.detail.job)}function F(e){s.zoneId=String(e.zoneID),m={name:"",condition:{zoneId:"",job:"NONE"},timeline:"",codeFight:"",create:""},y(s)}function N(e){c=!1,clearTimeout(Number(w)),callOverlayHandler({call:"cactbotSay",text:e}),w=setTimeout(()=>{c=!0},j)}function O(e){e.source==="soumuaTimelineSetting"&&e.msg.store&&b.fire({text:`\u63A5\u53D7\u5230${e.msg.store.allTimelines.length}\u4E2A\u65F6\u95F4\u8F74`,showDenyButton:!0,denyButtonText:"\u8986\u76D6",showConfirmButton:!0,confirmButtonText:"\u8FFD\u52A0",showCancelButton:!0,cancelButtonText:"\u653E\u5F03",backdrop:!1}).then(t=>{(t.isConfirmed||t.isDenied)&&(t.isDenied&&(i.allTimelines.length=0),i.allTimelines=e.msg.store.allTimelines,i.configValues=e.msg.store.configValues,i.showStyle=e.msg.store.showStyle,i.saveTimelineSettings(),b.fire("\u63A5\u53D7\u6210\u529F"),y(s))})}function V(e){!v&&e.detail.inACTCombat&&S(0),v&&!e.detail.inACTCombat&&d(m),v=e.detail.inACTCombat}return(e,t)=>(f(),g("div",H,[r(o).optionalTimeline.length&&r(l)<=-r(i).configValues.preBattle?(f(),g("ul",R,[(f(!0),g($,null,J(r(o).optionalTimeline,(n,u)=>(f(),g("li",{key:u,onClick:a=>D(n)},B(n.condition.job)+" - "+B(n.name),9,U))),128))])):Z("",!0),q(L,{config:r(i).configValues,lines:r(o).loadedTimeline,runtime:r(l),"show-style":r(i).showStyle},null,8,["config","lines","runtime","show-style"])]))}});var ne=M(G,[["__scopeId","data-v-19007c66"]]);export{ne as default};
