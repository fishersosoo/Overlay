import{u as N,S as m,T as L}from"./timeline.c4d4e054.js";import{_ as M}from"./index.2252d5a2.js";import{k as P,l as z,m as b,o as f,f as g,u,F as $,n as J,q as Z,h as q,t as A}from"./vendor.7e063442.js";import"https://overlay.diemoe.net/common/common.min.js";const H={id:"wrapper"},R={key:0,class:"optionalTimelines"},U=["onClick"],G=P({setup(K){const n=N(),o=z({loadedTimeline:[],optionalTimeline:[]});let T=b(0),a=b(0-n.configValues.preBattle),p=b(0),h,c=!0,B=300,w,s={zoneId:"0",job:"NONE"},v,y=!1;F();function F(){var e;addOverlayListener("onLogEvent",E),addOverlayListener("onPlayerChangedEvent",j),addOverlayListener("ChangeZone",I),addOverlayListener("BroadcastMessage",V),addOverlayListener("onInCombatChangedEvent",k),startOverlayEvents(),n.loadTimelineSettings(),s.job=(e=localStorage.getItem("timelineLastJob"))!=null?e:"NONE",setTimeout(()=>{!o.loadedTimeline.length&&!o.optionalTimeline.length&&(m.fire({text:`${n.allTimelines.length}\u6761\u65F6\u95F4\u8F74\u5DF2\u5C31\u7EEA`,timer:1500,showConfirmButton:!1,backdrop:!1}),window.hasOwnProperty("OverlayPluginApi")||m.fire({title:"\u672A\u68C0\u6D4B\u5230OverlayPlugin\u73AF\u5883",text:"\u8BF7\u5728ACT\u7684\u60AC\u6D6E\u7A97\u63D2\u4EF6\u4E2D\u6DFB\u52A0\u672C\u7F51\u9875",icon:"warning",confirmButtonColor:"#d33",confirmButtonText:"\u6211\u5C31\u8981\u5728\u8FD9\u7528\uFF01"}))},1e3)}function C(e){_(),o.loadedTimeline.length=0,o.optionalTimeline.length=0;let t=n.getTimeline(e);t.length===1?d(t[0]):t.length>1&&(o.optionalTimeline=t)}function D(e){d(e)}function d(e){e&&(e==null?void 0:e.timeline)&&(o.loadedTimeline=n.parseTimeline(e.timeline),o.loadedTimeline.sort((t,i)=>t.time-i.time),m.fire({position:"top-end",icon:"success",text:`\u52A0\u8F7D\u4E86${e.name}~`,showConfirmButton:!1,timer:1e3,backdrop:!1}),v=e)}function _(){clearInterval(Number(h)),T.value=0,a.value=0-n.configValues.preBattle,p.value=0}function S(e){T.value=new Date().getTime()+e*1e3,clearInterval(Number(h)),h=setInterval(()=>{a.value=(new Date().getTime()-T.value+p.value)/1e3;let t;o.loadedTimeline.filter(i=>i.tts&&!i.alertAlready&&i.time-n.configValues.ttsAdvance<=a.value).forEach(i=>{i.alertAlready=!0,i.tts&&c&&(t=i.tts,c=!1),t&&O(t)})},n.configValues.refreshRateMs)}function E(e){for(const t of e.detail.logs){let i=t.match(/^.{14} (\w+ |)00:(?:00b9|0139)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(]+[（(]/i);if(i)S(parseInt(i.groups.cd));else if(s.zoneId==="1009"&&/^.{14} (?:Director |)21:.{8}:8.{5}1A/.test(t))C(s);else if(/^.{14} (?:Director |)21:.{8}:40000010/.test(t))_(),d(v);else{const r=o.loadedTimeline.find(l=>l.sync&&l.windowBefore&&l.windowAfter&&l.sync.test(t)&&a.value>=l.time-l.windowBefore&&a.value<=l.time+Number(l.windowAfter));r&&x(r.jump||r.time)}}}function x(e){p.value+=(e-a.value)*1e3}function j(e){s.job!==e.detail.job&&(localStorage.setItem("timelineLastJob",e.detail.job),s.job=e.detail.job)}function I(e){s.zoneId=String(e.zoneID),C(s)}function O(e){c=!1,clearTimeout(Number(w)),callOverlayHandler({call:"cactbotSay",text:e}),w=setTimeout(()=>{c=!0},B)}function V(e){e.source==="soumuaTimelineSetting"&&e.msg.store&&m.fire({text:`\u63A5\u53D7\u5230${e.msg.store.allTimelines.length}\u4E2A\u65F6\u95F4\u8F74`,showDenyButton:!0,denyButtonText:"\u8986\u76D6",showConfirmButton:!0,confirmButtonText:"\u8FFD\u52A0",showCancelButton:!0,cancelButtonText:"\u653E\u5F03",backdrop:!1}).then(t=>{(t.isConfirmed||t.isDenied)&&(t.isDenied&&(n.allTimelines.length=0),n.allTimelines=e.msg.store.allTimelines,n.configValues=e.msg.store.configValues,n.showStyle=e.msg.store.showStyle,n.saveTimelineSettings(),m.fire("\u63A5\u53D7\u6210\u529F"),C(s))})}function k(e){!y&&e.detail.inACTCombat&&S(0),y&&!e.detail.inACTCombat&&d(v),y=e.detail.inACTCombat}return(e,t)=>(f(),g("div",H,[u(o).optionalTimeline.length&&u(a)<=-u(n).configValues.preBattle?(f(),g("ul",R,[(f(!0),g($,null,J(u(o).optionalTimeline,(i,r)=>(f(),g("li",{key:r,onClick:l=>D(i)},A(i.condition.job)+" - "+A(i.name),9,U))),128))])):Z("",!0),q(L,{config:u(n).configValues,lines:u(o).loadedTimeline,runtime:u(a),"show-style":u(n).showStyle},null,8,["config","lines","runtime","show-style"])]))}});var ee=M(G,[["__scopeId","data-v-1ebebcfe"]]);export{ee as default};
